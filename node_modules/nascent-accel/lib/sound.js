/* Sound handling
 * Wrapper around gstreamer
 * Inspiration drawn from the Spaghetti npm package
 */

'use strict';
var spawn = require('child_process').spawn;
var fs = require('fs');
var util = require('util');
var EventEmitter = require('events').EventEmitter;
var logger = require('./logger');
var LOG_TAG = 'system';

var app = 'gst-launch-1.0';
var default_output = 'pulsesink';
var default_input = 'autoaudiosrc';

function _runapp(args) {
	
	//console.log(args.join(' '));
	
	var child = spawn(app, args);
	
	child.stdout.on('data', function(data) {
		//console.log('stdout: ' + data);
	});
	
	child.stderr.on('data', function(data) {
		//console.log('stderr: ' + data);
	});
	
	child.on('close', function(code) {
		//console.log('app closed with code: ' + code);
	});
	
	return child;
}


/*
 * beep - play a sine wave using gstreamers audiotestsrc plugin
 * 
 * options object controls playback using the following members:
 * 
 * 	dest - output destination (defaults to default_output)
 *  freq - frequency in Hz (0-20000, defaults to 440)
 *  volume - volume of the test signal (0 to 1.0, defaults to 0.8)
 *  duration - length of beep in ms (default 500ms)
 */

function beep(options, cb) {
	
	var dest = options.dest || default_output;
	var freq = options.freq || 440;
	var volume = options.volume || 0.8;
	var duration = options.duration || 500;
	
	var args = [
	        'audiotestsrc', 'freq=' + freq, 'volume=' + volume,
	        '!', 'audioconvert',
	        '!', 'audioresample',
	        '!', dest
	        ];
	
	var child = _runapp(args);
	
	child.on('exit', function(code){
		//console.log(code)
		if(code) {
			if (cb) cb(new Error('exited with code ' + code));
		} else {
			if (cb) cb(null);
		}
	});
	
	if (duration) {
		setTimeout(function() {
			child.kill();
		}, duration);
	}

	return child;
}


function play(filepath, cb) {
	
	var dest = default_output;

	/* 
	 * decodebin will examine the file and determine which decoder is required.  
	 * It will return with an error if the required decoder is not installed.
	 * flac, ogg vorbis and wav are installed by default from gst-plugins-good
	 * aiff, aac and mp3 are in gst-plugins-bad and are not installed by default
	 */

	var args = [
	        'filesrc', 'location=' + filepath,
	        '!', 'decodebin',
	        '!', dest
	        ];
	
	var child = _runapp(args);
	
	child.on('exit', function(code){
		//console.log(code)
		if(code) {
			if (cb) cb(new Error(code));
		} else {
			if (cb) cb(null);
		}
	});
	
	return child;
}

function record(filepath, cb) {
	
	var src = default_input;
	
	/*
	 * assume flac for now
	 */
	
	var encoder = 'flacenc';

	var args = [
	        src,
	        '!', 'audioconvert',
	        '!', encoder,
	        '!', 'filesink', 'location=' + filepath
	        ];
	
	var child = _runapp(args);
	
	child.on('exit', function(code){
		console.log(code)
		if(code) {
			if (cb) cb(new Error(code));
		} else {
			if (cb) cb(null);
		}
	});
	
	return child;
}

function stop(child) {
	child.kill();
}

exports.beep = beep;
exports.play = play;
exports.record = record;
exports.stop = stop;
